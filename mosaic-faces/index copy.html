<html>
    <head>
        <meta charset="utf8">
        <title>全角半角判定 - Yapps</title>
        <link rel="icon" type="image/png" href="/img/logo.png">

        <link rel="stylesheet" href="/style.css">
		<link rel="stylesheet" href="/app-page.css">
		<link rel="stylesheet" href="/simple-textarea.css">
        <link rel="stylesheet" href="/button.css">
        <link rel="stylesheet" href="/checkbox.css">
        <link rel="stylesheet" href="./mosaic-faces.css">

        <script src="/js/jquery-3.5.1.min.js"></script>
        <script src="/js/common.js"></script>
        <script src="/js/opencv.js"></script>
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-43EGG0HL47"></script>

		<script src="./js/mosaic-faces.js"></script>
    </head>

    <body>
        <header>
            <div id="wrap" style="width: 100%;">
                <div id="header"></div>
            </div>
        </header>

        <div id="wrap">
            <div id="contents-wrap">
                <div class="title">
                    <img src="/img/tools_icon/text/char-checker.svg" type=”image/svg+xml” width="48" height="48" alt="全角半角変換">
                    顔モザイク加工
                </div>
                <p class="summary">
                    文章中の半角文字と全角文字を判定します。<br>
                </p>
                
                <div class="app-area" id="app-area-id">
                    <div>
                        <input type="file" id="fileInput" name="file" />
                    </div>
                    <div class="canvas-wrapper">
                        <canvas id="canvas"></canvas>
                        <div id="canvas-scroller">
                          <div class="inner" id="canvas-scroller-inner"></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <footer class="footer_class">
            <div id="footer"></div>
        </footer>


        <script>
            var Module = {
              onRuntimeInitialized: function() {
                console.log(Module.imread)
                const cv = Module;
      
                let fileInput = document.getElementById('fileInput');

                // ここから顔検出
                let gray = new cv.Mat();
                //cv.cvtColor(cvImage, gray, cv.COLOR_RGBA2GRAY, 0);
                let faces = new cv.RectVector();
                let faceCascade = new cv.CascadeClassifier();

                // 学習済みデータの読み込み
                faceCascade.load('/opencv/haarcascades/haarcascade_frontalface_default.xml');
                
                // ファイル読み込み時の動作
                fileInput.onchange = (e) => {
                  const image = new Image();
      
                  image.src = URL.createObjectURL(e.target.files[0]);
      
                  image.onload = ()  => {
                    //const canvas = document.getElementById('canvas');
                    //const context = canvas.getContext('2d');
      
                    //context.drawImage(image, 0, 0, image.width, image.height);
                    //const imageData = context.getImageData(0, 0, image.width, image.height);
                    
                    // 画像読み込み
                    drawMap(image)
                    
                    // opencvに読み込み
                    const cvImage = cv.imread("canvas");
                    const mean = cv.mean(cvImage)
                    console.log(`Mean: ${mean[0]}, ${mean[1]}, ${mean[2]}`)

                    // 顔検出
                    let msize = new cv.Size(0, 0);
                    faceCascade.detectMultiScale(cvImage, faces, 1.1, 3, 0, msize, msize);

                    // 検出した顔にモザイクをかける
                    for (let i = 0; i < faces.size(); ++i) {
                        //let face = faces.get(i);
                        //mosaic(cvImage, face);
                        let roiGray = gray.roi(faces.get(i));
                        let roiSec = cvImage.roi(faces.get(i));
                        let point1 = new cv.Point(faces.get(i).x, faces.get(i).y);
                        let point2 = new cv.Point(faces.get(i).x + faces.get(i).width, faces.get(i).y + faces.get(i).height);
                        cv.rectangle(cvImage, point1, point2, [255, 0, 0, 255]);
                    }

                    // 顔検出結果を表示
                    cv.imshow("canvas", cvImage);
                    cvImage.delete();
                    gray.delete();
                    faces.delete();
                    faceCascade.delete();
                  }
                };
              }
            };
          </script>
          <script src="https://docs.opencv.org/3.4.1/opencv.js"></script>
    </body>
</html>
